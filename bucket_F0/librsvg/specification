DEF[PORTVERSION]=	2.54.5
DEF[GTK_VERSION]=	EXTRACT_INFO(GTK2_VERSION)
DEF[SOVERSION]=		2.48.0
# ----------------------------------------------------------------------------

NAMEBASE=		librsvg
VERSION=		${PORTVERSION}
REVISION=		1
KEYWORDS=		graphics
VARIANTS=		standard
SDESC[standard]=	SVG vector-graphic files rendering library
HOMEPAGE=		http://live.gnome.org/LibRsvg
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GNOME/librsvg/${PORTVERSION:R}
DISTFILE[1]=		librsvg-${PORTVERSION}.tar.xz:main

SPKGS[standard]=	complete primary docs

OPTIONS_AVAILABLE=	INTROSPECTION
OPTIONS_STANDARD=	INTROSPECTION
OPT_ON[all]=		INTROSPECTION

# we can't use LICENSE_AWK/_SOURCE here (used before post-extract)
# Note, for rustless version, it's actually LGPL20+
LICENSE=		LGPL21+:primary
LICENSE_FILE=		LGPL21+:{{WRKSRC}}/COPYING.LIB
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		graphics/librsvg2-rust

BUILD_DEPENDS=		python-docutils:single:python_default
			rust:single:standard
BUILDRUN_DEPENDS=	freetype:primary:standard

USES=			cpe gettext-tools gmake gtk-doc png libtool pkgconfig
			perl:build python:build
GNOME_COMPONENTS=	cairo pango gdkpixbuf libxml2 libcroco
CPE_VENDOR=		gnome
MUST_CONFIGURE=		gnu
# vala caused circular dep (vala requires graphviz which requires librsvg)
CONFIGURE_ARGS=		--disable-vala
			--disable-Bsymbolic
			--docdir={{STD_DOCDIR}}
			--enable-gtk-doc-html=yes
CONFIGURE_ENV=		CARGO={{LOCALBASE}}/bin/cargo
			RUSTC={{LOCALBASE}}/bin/rustc
MAKE_ENV=		RUSTC={{LOCALBASE}}/bin/rustc
INSTALL_TARGET=		install-strip
INSTALL_REQ_TOOLCHAIN=	yes
PLIST_SUB=		PORTVERSION=${PORTVERSION}
			GTK_VERSION=${GTK_VERSION}
SOVERSION=		${SOVERSION}

[INTROSPECTION].DESCRIPTION=		Build with introspection
[INTROSPECTION].BUILD_DEPENDS_ON=	python-gi-docgen:single:python_default
[INTROSPECTION].GNOME_COMPONENTS_ON=	introspection
[INTROSPECTION].CONFIGURE_ARGS_ON=	--enable-gtk-doc
[INTROSPECTION].CONFIGURE_ARGS_OFF=	--enable-introspection=no

post-patch:
	# extract license terms
	${AWK} '/RSVG_H/ {exit}; {print}' ${WRKSRC}/include/librsvg/rsvg.h > ${WRKDIR}/TERMS

pre-configure:
	# disable vendor checksums
	${REINPLACE_CMD} -e 's/"files":{[^}]*}/"files":{}/' \
		${WRKSRC}/vendor/*/.cargo-checksum.json
	cd ${WRKSRC} && ${SETENV} ${CONFIGURE_ENV} \
		${LOCALBASE}/bin/cargo update

post-install:
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/bin/rsvg-convert
