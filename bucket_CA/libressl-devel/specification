DEF[PORTVERSION]=	3.2.2
DEF[SOVERSION]=		48.1.0
DEF[TLS_SOVERSION]=	20.1.0
DEF[CRY_SOVERSION]=	46.1.0
DEF[NAMEBASE]=		libressl-devel
DEF[BASE]=		{{PREFIX}}/${NAMEBASE}
# ----------------------------------------------------------------------------

NAMEBASE=		${NAMEBASE}
VERSION=		${PORTVERSION}
KEYWORDS=		security devel
VARIANTS=		standard static
SDESC[standard]=	OpenBSD fork of the OpenSSL SSL/TLS protocol
SDESC[static]=		Static minimal version of LibreSSL
HOMEPAGE=		http://www.libressl.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		OPENBSD/LibreSSL
DISTFILE[1]=		libressl-${PORTVERSION}.tar.gz:main

SPKGS[standard]=	single
SPKGS[static]=		single

OPTIONS_AVAILABLE=	STATIC SKIP_MANPAGES
OPTIONS_STANDARD=	SKIP_MANPAGES
VOPTS[static]=		STATIC=ON SKIP_MANPAGES=ON

LICENSE=		OpenSSL:single ISCL:single
LICENSE_FILE=		OpenSSL:{{WRKSRC}}/COPYING
			ISCL:{{WRKSRC}}/COPYING
LICENSE_SCHEME=		multi

FPC_EQUIVALENT=		security/${NAMEBASE}

RUN_DEPENDS=		autoselect-ssl:single:standard

USES=			cpe pkgconfig cmake
DISTNAME=		libressl-${PORTVERSION}
CPE_VENDOR=		openbsd
CPE_PRODUCT=		libressl
CMAKE_INSTALL_PREFIX=	${BASE}
CMAKE_ARGS=		-DENABLE_NC:BOOL=ON
			-DOPENSSLDIR:PATH="{{PREFIX}}/etc/${NAMEBASE}"
SOVERSION=		${SOVERSION}
PLIST_SUB=		CRY_SOMAJOR=${CRY_SOVERSION:R:R}
			CRY_SOVERSION=${CRY_SOVERSION}
			TLS_SOMAJOR=${TLS_SOVERSION:R:R}
			TLS_SOVERSION=${TLS_SOVERSION}

[STATIC].CMAKE_ARGS_ON=			-DBUILD_SHARED_LIBS:BOOL=OFF
[STATIC].CMAKE_ARGS_OFF=		-DBUILD_SHARED_LIBS:BOOL=ON
					-DCMAKE_INSTALL_RPATH:STRING="${BASE}/lib"

[SKIP_MANPAGES].DESCRIPTION=		Skip LibreSSL manpage installation

post-patch:
	# There is a conflict within the static libcrypto.a with the
	# arc4random, arc4random_buf, and arc4random_uniform.  These
	# functions also exist in in FreeBSD's system libc. To resolve,
	# don't use libressl builtin versions.
	${REINPLACE_CMD} -e '/DHAVE_ARC4RANDOM/d' ${WRKSRC}/CMakeLists.txt

post-build-STATIC-OFF:
	# assemble PIC libraries
	cd ${BUILD_WRKSRC} &&\
		${AR} -crsv libcrypto_pic.a \
		crypto/CMakeFiles/crypto.dir/*.o \
		crypto/CMakeFiles/crypto.dir/*/*.o \
		&& ranlib libcrypto_pic.a
	cd ${BUILD_WRKSRC} &&\
		${AR} -crsv libssl_pic.a \
		ssl/CMakeFiles/ssl.dir/*.o \
		&& ranlib libssl_pic.a
	cd ${BUILD_WRKSRC} &&\
		${AR} -crsv libtls_pic.a \
		tls/CMakeFiles/tls.dir/*.o \
		&& ranlib libtls_pic.a

post-install:
	${STRIP_CMD} ${STAGEDIR}${BASE}/bin/nc
	${STRIP_CMD} ${STAGEDIR}${BASE}/bin/ocspcheck
	${STRIP_CMD} ${STAGEDIR}${BASE}/bin/openssl
	${RM} -r ${STAGEDIR}/${PREFIX}/etc/${NAMEBASE}/cert.pem

post-install-STATIC-OFF:
	# install our PIC libraries
	${INSTALL_DATA} \
		${BUILD_WRKSRC}/libcrypto_pic.a \
		${BUILD_WRKSRC}/libssl_pic.a \
		${BUILD_WRKSRC}/libtls_pic.a \
		${STAGEDIR}${PREFIX}/${NAMEBASE}/lib/
	${STRIP_CMD} ${STAGEDIR}${BASE}/lib/*.so

post-patch-SKIP_MANPAGES-ON:
	${REINPLACE_CMD} -e '/add_subdirectory.man./d' \
		${WRKSRC}/CMakeLists.txt

post-install-SKIP_MANPAGES-ON:
	${RM} -r ${STAGEDIR}${BASE}/share

post-install-SKIP_MANPAGES-OFF:
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/man.d
	${ECHO_CMD} "MANPATH ${PREFIX}/${NAMEBASE}/share/man" \
		>> ${STAGEDIR}${PREFIX}/etc/man.d/${NAMEBASE}.conf
