DEF[PORTVERSION]=	2.2.8
# ----------------------------------------------------------------------------

NAMEBASE=		cups
VERSION=		${PORTVERSION}
KEYWORDS=		print
VARIANTS=		standard
SDESC[standard]=	Common UNIX Printing System
HOMEPAGE=		https://www.cups.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/apple:cups:v${PORTVERSION}
DISTFILE[1]=		generated:main

SPKGS[standard]=	complete primary docs examples

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

LICENSE=		APACHE20:primary
LICENSE_FILE=		APACHE20:{{WRKSRC}}/LICENSE.txt
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_AWK=		TERMS:"^$$"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/cups/cups.h
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		print/cups

RC_SUBR=		cupsd:primary
GROUPS=			cups
USERS=			cups
USERGROUP_SPKG=		primary

BUILDRUN_DEPENDS=	gnutls:single:standard
			libpaper:single:standard
			dbus:single:standard

USES=			cpe gmake iconv pkgconfig
CPE_VENDOR=		apple
DESTDIRNAME=		DSTROOT
MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--enable-libpaper
			--enable-gnutls
			--enable-dbus
			--disable-dnssd
			--disable-gssapi
			--disable-launchd
			--disable-systemd
			--disable-avahi
			--with-cups-user=cups
			--with-cups-group=cups
			--with-dbusdir="{{PREFIX}}/etc/dbus-1"
			--with-icondir="{{PREFIX}}/share/icons"
			--with-menudir="{{PREFIX}}/share/applications"
			--with-printcap="{{PREFIX}}/etc/printcap"
			--with-rcdir=no
			--with-optim=" "
			--with-pam-module="unix"
CONFIGURE_ENV=		ac_cv_path_JAVA=
			ac_cv_path_PERL=
			ac_cv_path_PHPCGI=
			ac_cv_path_PHP=
			ac_cv_path_PYTHON=

VAR_OPSYS[freebsd]=	CONFIGURE_ARGS=--with-system-groups=wheel
VAR_OPSYS[dragonfly]=	CONFIGURE_ARGS=--with-system-groups=wheel

post-patch:
	${REINPLACE_CMD} -e '/SILENT/d' ${WRKSRC}/Makedefs.in
	${REINPLACE_CMD} 's/usblp/ulpt/g' ${WRKSRC}/backend/usb-libusb.c
	${REINPLACE_CMD} -e 's|/usr/local/etc/pam.d|${LOCALBASE}/etc/pam.d|' \
		-e 's/-fstack-protector//' ${WRKSRC}/configure
	${FIND} ${WRKSRC}/doc ${WRKSRC}/templates -type f -exec ${SED} -i'' \
		's|http://www.cups.org|https://www.cups.org|g' {} +
	${REINPLACE_CMD} '/stripopt=/s/-x//' ${WRKSRC}/install-sh
	${REINPLACE_CMD} 's|/etc/cups|${LOCALBASE}/etc/cups|g' \
		${WRKSRC}/man/*.man*
	${REINPLACE_CMD} -e 's|\.default|.sample|'\
		-e 's|-g .(.*_GROUP)||g' \
		${WRKSRC}/cgi-bin/admin.c\
		${WRKSRC}/conf/Makefile \
		${WRKSRC}/notifier/Makefile \
		${WRKSRC}/scheduler/Makefile

post-install:
	${LN} -sf lpr ${STAGEDIR}${PREFIX}/bin/lpr-cups
	@${MKDIR} ${STAGEDIR}${PREFIX}/etc/pam.d \
		${STAGEDIR}${PREFIX}/etc/devd \
		${STAGEDIR}${STD_EXAMPLESDIR}
	${INSTALL_DATA} ${FILESDIR}/cups.conf.sample \
		${STAGEDIR}${PREFIX}/etc/devd
	${INSTALL_DATA} ${FILESDIR}/cups ${STAGEDIR}${PREFIX}/etc/pam.d
	${MV} ${STAGEDIR}${PREFIX}/share/cups/examples/* \
		${STAGEDIR}${STD_EXAMPLESDIR}
	${RMDIR} ${STAGEDIR}${PREFIX}/share/cups/examples
	${RM} ${STAGEDIR}${PREFIX}/etc/cups/*.conf
