DEF[PORTVERSION]=	1.10.99.6
DEF[ROLLING_TAG]=	ca9e43f
# ----------------------------------------------------------------------------

NAMEBASE=		pkg-bsd
VERSION=		${PORTVERSION}
REVISION=		4
KEYWORDS=		raven
VARIANTS=		standard
SDESC[standard]=	BSD binary package manager
HOMEPAGE=		https://github.com/freebsd/pkg/blob/master/README.md
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/jrmarino:pkg:${ROLLING_TAG}
DISTFILE[1]=		generated:main

SPKGS[standard]=	complete shared static

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

LICENSE=		BSD2CLAUSE:shared
LICENSE_FILE=		BSD2CLAUSE:{{WRKSRC}}/COPYING
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		ports-mgmt/pkg

BUILDRUN_DEPENDS=	libarchive-devel:shared:standard
BUILD_DEPENDS=		libarchive-devel:static:standard
			zlib:static:standard
			bzip2:static:standard
			autoconf:single:standard
			automake:single:standard
BR_DEPS[linux]=		libbsd:single:standard
BR_DEPS[sunos]=		libbsd4sol:single:standard
			musl-fts:single:standard

USES=			libtool:build
MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--disable-maintainer-mode
			--mandir={{MANPREFIX}}/man
INSTALL_TARGET=		install-strip
CFLAGS=			-Wno-error
SINGLE_JOB=		yes

VAR_OPSYS[sunos]=	CFLAGS=-I{{LOCALBASE}}/include/bsd

pre-patch:
	${REINPLACE_CMD} -e 's/larchive/larchive-devel/' \
		${WRKSRC}/libpkg/Makefile.am \
		${WRKSRC}/tests/Makefile.am \
		${WRKSRC}/src/Makefile.am
	${REINPLACE_CMD} -e 's/\[archive\]/[archive-devel]/' \
		${WRKSRC}/configure.ac
	(cd ${WRKSRC} && ./autogen.sh)

post-patch-linux:
	${REINPLACE_CMD} -e '/libpkg_la_LDFLAGS =/ s/= /= -ldl /' \
		${WRKSRC}/libpkg/Makefile.in

post-patch-sunos:
	${REINPLACE_CMD} -e 's|-lutil ||' \
		${WRKSRC}/libpkg/Makefile.in \
		${WRKSRC}/tests/Makefile.in

post-install:
	${RM} ${STAGEDIR}${PREFIX}/sbin/pkg2ng
	${MV} ${STAGEDIR}${PREFIX}/lib/libpkg_static.a \
		${STAGEDIR}${PREFIX}/lib/libpkg.a
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/periodic/411.pkg-backup \
		${WRKSRC}/scripts/periodic/490.status-pkg-changes \
		${STAGEDIR}${PREFIX}/etc/periodic/daily/
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/periodic/460.pkg-checksum \
		${WRKSRC}/scripts/periodic/410.pkg-audit \
		${STAGEDIR}${PREFIX}/etc/periodic/security/
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/periodic/400.status-pkg \
		${STAGEDIR}${PREFIX}/etc/periodic/weekly/
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/pkg/repos
