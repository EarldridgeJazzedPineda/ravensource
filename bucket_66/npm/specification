DEF[PORTVERSION]=	8.19.2
# ----------------------------------------------------------------------------

NAMEBASE=		npm
VERSION=		${PORTVERSION}
KEYWORDS=		www
VARIANTS=		standard
SDESC[standard]=	Node.js Package Manager
HOMEPAGE=		https://www.npmjs.com/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/npm:cli:v${PORTVERSION}
DISTFILE[1]=		generated:main

SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

LICENSE=		ART20:single
LICENSE_FILE=		ART20:{{WRKSRC}}/lib/node_modules/npm/LICENSE
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		www/npm

BUILDRUN_DEPENDS=	bash:complete:standard
			nodejs:complete:standard

USES=			cpe python shebangfix gmake perl:build
CPE_VENDOR=		cli_project
CPE_PRODUCT=		cli
CPE_TARGET_SW=		node.js
SINGLE_JOB=		yes
SHEBANG_GLOB=		*.py
			resetdeps.sh
SHEBANG_FILES=		lib/utils/completion.sh
MANDIRS=		{{PREFIX}}/lib/node_modules/npm/man

# Seems we can't build the documentation, no man pages anymore
BUILD_TARGET=		mandocs
SKIP_BUILD=		yes

post-patch:
	${GREP} -rl "/usr/local" ${WRKSRC} | ${XARGS} \
		${REINPLACE_CMD} -e 's|/usr/local|${LOCALBASE}|g'
	${GREP} -rl "/usr/bin/env node" ${WRKSRC} | ${XARGS} \
		${REINPLACE_CMD} -e 's|/usr/bin/env node|${LOCALBASE}/bin/node|'
	${GREP} -rl "/usr/bin/env bash" ${WRKSRC} | ${XARGS} \
		${REINPLACE_CMD} -e 's|/usr/bin/env bash|${LOCALBASE}/bin/bash|'
	${GREP} -rl "exec python" ${WRKSRC} | ${XARGS} \
		${REINPLACE_CMD} -e 's|exec python|exec ${PYTHON_CMD}|'
	# fix python location
	${REINPLACE_CMD} -e 's|PYTHONBIN|${PYTHON_CMD}|' \
		${WRKSRC}/node_modules/node-gyp/lib/configure.js
	${FIND} ${WRKSRC} \( -name "*.bak" -o -name "*.orig" \) -type f -delete

do-install:
	cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${MAKE_ARGS} \
		${LOCALBASE}/bin/node bin/npm-cli.js pack
	cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${MAKE_ARGS} \
		${LOCALBASE}/bin/node bin/npm-cli.js \
		install -g -f npm-${PORTVERSION}.tgz
	${ECHO_CMD} 'python=${PYTHON_CMD}' > ${STAGEDIR}${PREFIX}/etc/npmrc
	# repeat shebang fix
	${FIND} ${STAGEDIR}${PREFIX}/lib/node_modules/npm/node_modules/node-gyp -type f -name "*.py" |\
		${XARGS} ${SED} -i'' -e "s|/usr/bin/env python|${PYTHON_CMD}|"
