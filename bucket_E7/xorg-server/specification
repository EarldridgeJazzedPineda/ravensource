DEF[PORTVERSION]=	21.1.1
# ----------------------------------------------------------------------------

NAMEBASE=		xorg-server
VERSION=		${PORTVERSION}
KEYWORDS=		x11_servers
VARIANTS=		standard virtual xephyr nest
SDESC[standard]=	X.Org X server and related programs
SDESC[virtual]=		X virtual framebuffer server from X.Org
SDESC[nest]=		Nesting X server from X.Org
SDESC[xephyr]=		X server from X.Org based on kdrive
HOMEPAGE=		https://www.x.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		XORG/individual/xserver
DISTFILE[1]=		xorg-server-${PORTVERSION}.tar.xz:main

SPKGS[standard]=	single
SPKGS[virtual]=		single
SPKGS[nest]=		single
SPKGS[xephyr]=		single

OPTIONS_AVAILABLE=	XORG VIRTUAL XEPHYR NEST DEVD SUID
OPTIONS_STANDARD=	XORG DEVD SUID
VOPTS[virtual]=		XORG=OFF VIRTUAL=ON XEPHYR=OFF NEST=OFF DEVD=OFF SUID=OFF
VOPTS[xephyr]=		XORG=OFF VIRTUAL=OFF XEPHYR=ON NEST=OFF DEVD=OFF SUID=OFF
VOPTS[nest]=		XORG=OFF VIRTUAL=OFF XEPHYR=OFF NEST=ON DEVD=OFF SUID=OFF
OPT_ON[all]=		XORG SUID

LICENSE=		MIT:single
LICENSE_FILE=		MIT:{{WRKSRC}}/COPYING
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		x11-servers/xorg-server

BUILD_DEPENDS=		xorg-fontutil:single:standard
			xorg-xkbfile:single:standard
RUN_DEPENDS=		xorg-xkeyboard-config:primary:standard
			xorg-xkbcomp:single:standard
BUILDRUN_DEPENDS=	xorg-xcvt:single:standard

USES=			cpe gmake libtool perl:build ssl solaris-funcs
XORG_COMPONENTS=	xorgproto xtransproto
			pixman xshmfence xau xdmcp xfont2
CPE_VENDOR=		x.org
SOL_FUNCTIONS=		strnlen:xkb/XKBGAlloc.c
MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--with-xkb-path={{LOCALBASE}}/share/X11/xkb
			--with-fontrootdir={{LOCALBASE}}/share/fonts
			--without-doxygen
			--without-xmlto
			--without-fop
			--localstatedir=/var
			--disable-config-hal
			--disable-config-udev
			--disable-config-udev-kms
			--disable-install-setuid
			--without-dtrace
			--enable-glamor
			--enable-xcsecurity
			--enable-xtrans-send-fds=yes
INSTALL_TARGET=		install-strip

VAR_OPSYS[sunos]=	CFLAGS=-DO_CLOEXEC=0
# #			For reallocarray:
VAR_OPSYS[netbsd]=	CPPFLAGS=-D_OPENBSD_SOURCE

[XORG].DESCRIPTION=			Build as X server (don't change setting!)
[VIRTUAL].DESCRIPTION=			Build as virtual framebuffer server
[XEPHYR].DESCRIPTION=			Build as kdrive-base X server
[NEST].DESCRIPTION=			Build as nesting X server
[DEVD].DESCRIPTION=			Use devd for autoconfiguration of input devices
[SUID].DESCRIPTION=			Install the Xorg server with setuid bit set

[XORG].BUILDRUN_DEPENDS_ON=		libdrm:single:standard
					libepoxy:single:standard
					mesa:drivers:standard
[XEPHYR].BUILDRUN_DEPENDS_ON=		libdrm:single:standard
					libepoxy:single:standard
[VIRTUAL].BUILD_DEPENDS_ON=		libepoxy:single:standard
					mesa:drivers:standard
[NEST].BUILD_DEPENDS_ON=		libepoxy:single:standard
					mesa:drivers:standard
[XEPHYR].BUILD_DEPENDS_ON=		mesa:drivers:standard

[XORG].USES_ON=				mesa
[NEST].USES_ON=				mesa
[XEPHYR].USES_ON=			mesa
[VIRTUAL].USES_ON=			mesa

[NEST].CONFIGURE_ENABLE_BOTH=		xnest
[VIRTUAL].CONFIGURE_ENABLE_BOTH=	xvfb
[XEPHYR].CONFIGURE_ENABLE_BOTH=		xephyr kdrive
[XORG].CONFIGURE_ENABLE_BOTH=		docs devel-docs xorg

[NEST].XORG_COMPONENTS_ON=		x11 xext
[XEPHYR].XORG_COMPONENTS_ON=		x11 xcb xcb-util xcb-util-image
					xcb-util-wm xcb-util-keysyms xcb-render-util
[XORG].XORG_COMPONENTS_ON=		pciaccess xfont2

[XORG].SUB_FILES_ON=			pkg-install-single pkg-deinstall-single

post-patch:
	# build libglx.so but don't install it yet. (done in pre-install)
	${REINPLACE_CMD} -e 's|@GLX_TRUE@GLXMODS =|@GLX_BOGUS@GLXMODS =|g' \
		-e 's|^LTLIBRARIES = |LTLIBRARIES = libglx.la |g' \
		${WRKSRC}/hw/xfree86/dixmods/Makefile.in

post-configure-DEVD-ON:
	${REINPLACE_CMD} -e 's|config\.c|config.c devd.c|g' \
		-e 's|config\.lo|config.lo devd.lo|g' \
		${WRKSRC}/config/Makefile
	${REINPLACE_CMD} -e 's|^/\* #undef CONFIG_UDEV \*/|#define CONFIG_DEVD 1|' \
		${WRKSRC}/include/dix-config.h

post-install-XORG-ON:
	# The .xorg dir because else the xorg-server might not load the
	# correct libglx module.
	${MKDIR} ${STAGEDIR}${PREFIX}/lib/xorg/modules/extensions/.xorg
	${INSTALL_LIB} ${WRKSRC}/hw/xfree86/dixmods/.libs/libglx.so \
		${STAGEDIR}${PREFIX}/lib/xorg/modules/extensions/.xorg/
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/X11/xorg.conf.d
	${RM} -r ${STAGEDIR}/var

post-install-XORG-OFF:
	${RM} -r ${STAGEDIR}${PREFIX}/lib/xorg
	${RM} ${STAGEDIR}${PREFIX}/share/man/man1/Xserver.1

do-install-VIRTUAL-ON:
	(cd ${WRKSRC}/hw/vfb && \
		DESTDIR=${STAGEDIR} ${MAKE_CMD} install)

do-install-XEPHYR-ON:
	(cd ${WRKSRC}/hw/kdrive/ephyr && \
		DESTDIR=${STAGEDIR} ${MAKE_CMD} install)

do-install-NEST-ON:
	(cd ${WRKSRC}/hw/xnest && \
		DESTDIR=${STAGEDIR} ${MAKE_CMD} install)
