DEF[PORTVERSION]=	EXTRACT_VERSION(PYTHON_3.5_VERSION)
DEF[PYTHON_VER]=	${PORTVERSION:R}
DEF[PYTHON_VERSION]=	python${PYTHON_VER}
DEF[PYTHON_SUFFIX]=	${PYTHON_VER:S/.//g}
# ----------------------------------------------------------------------------

NAMEBASE=		python${PYTHON_SUFFIX}
VERSION=		${PORTVERSION}
KEYWORDS=		lang python
VARIANTS=		standard
SDESC[standard]=	Interpreted object-oriented programming language
HOMEPAGE=		https://www.python.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		http://www.python.org/ftp/python/${PORTVERSION}/
DISTFILE[1]=		Python-${PORTVERSION}.tar.xz:main

SPKGS[standard]=	single

OPTIONS_AVAILABLE=	THREADS DEBUG PYMALLOC
OPTIONS_STANDARD=	THREADS DEBUG PYMALLOC
OPT_ON[all]=		THREADS PYMALLOC

BUILDRUN_DEPENDS=	libffi:single:standard
			zlib:complete:standard
			expat:complete:standard
			bzip2:complete:standard
			xz:single:standard
BROKEN_SSL=		openssl-devel

USES=			cpe ncurses pkgconfig readline ssl shebangfix
DISTNAME=		Python-${PORTVERSION}
INSTALL_REQ_TOOLCHAIN=	yes
SINGLE_JOB=		yes
CPE_VENDOR=		python
CPE_PRODUCT=		python
CPE_VERSION=		${PORTVERSION}
SHEBANG_NEW_PYTHON=	{{PREFIX}}/bin/python${PYTHON_VER}
SHEBANG_FILES=		Lib/lib2to3/tests/data/*.py
			Lib/encodings/*.py

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--with-system-ffi
			--with-system-expat
			--enable-shared
			--without-ensurepip
			--enable-ipv6
CONFIGURE_ENV=		OPT=""
			DISABLED_EXTENSIONS="_sqlite3 _tkinter _gdbm"
CFLAGS=			-I{{NCURSESINC}}
INSTALL_TARGET=		altinstall
TEST_TARGET=		buildbottest
TEST_ARGS=		TESTOPTS=-j{{MAKE_JOBS_NUMBER}}
MAKE_ARGS=		INSTALL_SHARED="{{INSTALL_LIB}}"
SUB_FILES=		pkg-message-single
SUB_LIST=		PYTHON_SUFFIX=${PYTHON_SUFFIX}
PLIST_SUB=		XYDOT=${PYTHON_VER}
			XY=${PYTHON_SUFFIX}
			XYZDOT=${PORTVERSION}
			LOW_OPSYS={{OPSYS:tl}}
			OSMAJOR={{MAJOR:R}}
			ABI={{ABIFLAGS}}

[THREADS].CONFIGURE_WITH_BOTH=		threads
[THREADS].LDFLAGS_ON=			-pthread

[DEBUG].CONFIGURE_WITH_BOTH=		pydebug
[DEBUG].MAKEFILE_ON=			ABIFLAGS:=d{{ABIFLAGS}}

[PYMALLOC].DESCRIPTION=			Enable specialized mallocs
[PYMALLOC].CONFIGURE_WITH_BOTH=		pymalloc
[PYMALLOC].MAKEFILE_ON=			ABIFLAGS:=m{{ABIFLAGS}}

post-patch:
	${REINPLACE_CMD} -e 's|/usr/local/bin/python|${python_CMD}|' \
		${WRKSRC}/Lib/cgi.py

post-install-DEBUG-OFF:
	# Upstream Issue: http://bugs.python.org/issue17975
	${RM} ${STAGEDIR}${PREFIX}/lib/libpython3.so

post-install:
	for i in ${STAGEDIR}${PREFIX}/lib/python${PYTHON_VER}/lib-dynload/*.so; do \
		${STRIP_CMD} $$i; \
	done
