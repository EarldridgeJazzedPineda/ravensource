#!/bin/sh
#
# Make wget masquerade as fetch
# look for:
#   -q : (quiet),       wget=--quiet
#   -o : (output=file), wget=--output-document
#   --no-verify-peer,   wget=--no-check-certificate
#   -Fpr : (force-restart, passive (default), restart, keep output),
#          wget=
#   --require-size,     wget= NOT SUPPORTED (mimickable?)
#  assume env: SSL_NO_VERIFY_PEER=1 SSL_NO_VERIFY_HOSTNAME=1

VERBOSITY="--no-verbose"
CERTS="--no-check-certificate --ca-certificate %%PREFIX%%/share/certs/ca-root-nss.crt"
REQUIRE_SIZE=0
OUTPUT_FILE=
SENDTO=
URL=not-defined

while test ${#} -gt 0
do
   case "${1}" in
      -q|--quiet)
      		VERBOSITY="--quiet"
      		;;
      --no-verify-peer)
      		;;
      -F|-p|-r|-Fpr|-Fp|-pF|-Fr|-rF|-pr|-rp|-rpF|-rFp|-pFr|-prF)
      		;;
      -S|--require-size)
		shift
      		REQUIRE_SIZE=${1}
      		;;
      -o)
      		shift
      		OUTPUT_FILE="${1}"
      		;;
      *)
      		URL="${1}"
      		;;
   esac
   shift
done

GETLENGTH='\
BEGIN { remotelen = 0 }\
/^Length:/ { remotelen = $2}\
{ next }\
END {\
  if (!remotelen) { print "continue" }\
  else {\
    if (remotelen != knownlen)\
      { printf ("size mismatch: expected %d, actual %d\n", knownlen, remotelen) }\
    else\
      { print "continue" }\
  }\
}'

LASTSEG='{ print $NF }'
BPATH1=$(/usr/bin/dirname ${0})
BASEPATH=$(cd ${BPATH1} && /bin/pwd)
WGET="${BASEPATH}/wget"

if [ -n "${OUTPUT_FILE}" ]; then
	# If this is a directory, calculate the full output file name
	if [ -d "${OUTPUT_FILE}" ]; then
	   checkfile=$(echo ${URL} | awk -F'/' "${LASTSEG}")
	   OUTPUT_FILE="${OUTPUT_FILE}/${checkfile}"
	fi
	SENDTO="--output-document ${OUTPUT_FILE}"
else
	# pre-delete any existing file (top level only)
	checkfile=$(echo ${URL} | awk -F'/' "${LASTSEG}")
	if [ -f "${checkfile}" ]; then
	   rm -f ${checkfile}
	fi
fi
if [ ${REQUIRE_SIZE} -gt 0 ]; then
   message=$(${WGET} --spider ${URL} 2>&1 | awk -vknownlen=${REQUIRE_SIZE} "${GETLENGTH}")
   if [ "${message}" != "continue" ]; then
      echo ${message}
      exit 1
   fi
fi
COMMAND="${WGET} ${VERBOSITY} ${CERTS} ${URL} ${SENDTO}"

${COMMAND}
