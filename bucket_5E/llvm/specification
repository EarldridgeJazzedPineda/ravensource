DEF[LLVM_VERSION]=	7.0.0
DEF[PORTREVISION]=	2
DEF[PORTVERSION]=	${LLVM_VERSION}
DEF[MAJORMIN]=		${PORTVERSION:R}
DEF[MAJOR]=		${PORTVERSION:R:R}
# ----------------------------------------------------------------------------

NAMEBASE=		llvm
VERSION=		${PORTVERSION}
REVISION=		${PORTREVISION}
KEYWORDS=		devel lang
VARIANTS=		standard
SDESC[standard]=	Low Level Virtual Machine (version ${MAJORMIN})
HOMEPAGE=		http://llvm.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		http://llvm.org/releases/${LLVM_VERSION}/
DISTFILE[1]=		llvm-${PORTVERSION}.src.tar.xz:main

SPKGS[standard]=	single

OPTIONS_AVAILABLE=	GOLD
OPTIONS_STANDARD=	GOLD
OPT_ON[freebsd]=	GOLD//x86_64
OPT_ON[dragonfly]=	GOLD//x86_64
OPT_ON[linux]=		GOLD//x86_64
OPT_ON[sunos]=		GOLD//x86_64

LICENSE=		CUSTOM1:single
LICENSE_NAME=		CUSTOM1:"University of Illinois/NCSA Open Source License"
LICENSE_FILE=		CUSTOM1:{{WRKSRC}}/LICENSE.TXT
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		devel/llvm50

USES=			cmake:outsource ncurses python:build
			execinfo zlib c++:single
GNOME_COMPONENTS=	libxml2
DISTNAME=		llvm-${PORTVERSION}.src
CMAKE_ARGS=		-DLLVM_BUILD_LLVM_DYLIB=ON
			-DCMAKE_INSTALL_RPATH:STRING="{{LOCALBASE}}/llvm/lib"
			-DLLVM_HOST_TRIPLE:STRING="{{CONFIGURE_TARGET}}"
CMAKE_BUILD_TYPE=	Release
PLIST_SUB=		LLVM_RELEASE="${LLVM_VERSION}"
			LLVM_MAJOR="${MAJOR}"

[GOLD].DESCRIPTION=			Build the LLVM Gold plugin for LTO
[GOLD].CMAKE_ARGS_ON=			-DLLVM_BINUTILS_INCDIR={{LOCALBASE}}/toolchain/include
					-DLLVM_USE_LINKER=gold

post-patch:
	${REINPLACE_CMD} -e "s|/usr/local|${PREFIX}|g" \
		${WRKSRC}/CMakeLists.txt

post-install:
	${RM} -r ${STAGEDIR}${MANPREFIX}/man
	${RM} -r ${STAGEDIR}${PREFIX}/share/man
	${RM} -r ${STAGEDIR}${PREFIX}/include/llvm/MC/MCAnalysis
	${RM} -r ${STAGEDIR}${PREFIX}/include/llvm/BinaryFormat/WasmRelocs
.for F in bugpoint dsymutil llc lli llvm-ar llvm-as llvm-bcanalyzer \
	llvm-c-test llvm-cat llvm-cfi-verify llvm-config llvm-cov \
	llvm-cvtres llvm-cxxdump llvm-cxxfilt llvm-diff llvm-dis \
	llvm-dwarfdump llvm-dwp llvm-exegesis llvm-extract llvm-link \
	llvm-lto llvm-lto2 llvm-mc llvm-mca llvm-modextract llvm-mt \
	llvm-nm llvm-objcopy llvm-objdump llvm-opt-report llvm-pdbutil \
	llvm-profdata llvm-rc llvm-readobj llvm-rtdyld llvm-size \
	llvm-split llvm-stress llvm-strings llvm-symbolizer llvm-tblgen \
	llvm-undname llvm-xray obj2yaml opt sancov sanstats \
	verify-uselistorder yaml2obj
	${STAGEDIR}${PREFIX}/bin/llvm-strip ${STAGEDIR}${PREFIX}/bin/${F}
.endfor
.for F in BugpointPasses.so LLVMHello.so LLVMgold.so TestPlugin.so \
	libLLVM-${MAJOR}.so libLTO.so.${MAJOR}
	${STAGEDIR}${PREFIX}/bin/llvm-strip ${STAGEDIR}${PREFIX}/lib/${F}
.endfor
